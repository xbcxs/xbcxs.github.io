# 内存溢出20200710

## 场景
早上系统运行一段时间后，请求响应边慢，后台日志开始出现内存溢出日志。


## 问题处理

### 线上分析
通知运维暂时调大JVM内存，为开发定位问题争取时间。

开发开始监控heap变化。通过lsof -i:5000 找到PID。

通过jstat -gc pid 1231 30000 30S刷新一次GC，观察其使用情况。

后来发现早上重启系统，客户陆续登录系统运行一段时间后，GC老年代存储用满，FGC无法回收，

#### [jstack]CPU占用率高分析

1.查看cpu占用高进程

```
top
```

2.查看高进程ID下高线程PID

```
top -H -p 进程PID
```

3.转换线程ID

```
printf "0x%x\n" 线程PID
```

4.定位异常线程

```
jstack 进程PID | grep 16进制线程PID -A 30
```
（需要和进程是同一用户）
也可以jstack 进程PID > /dir/xxx.txt；再用16进制线程ID在xxx.txt搜索相关信息。
查看引起异常线程的相关代码，找到跟VO有关的代码调用错误。

### 线下分析

从/tmp下获取相关java_pid660-0710-1003.hprof dumpr日志。

使用MemoryAnalyzer进行日志分析，通过Histogram分析返现有一个VO对象Retained Hadp很大。

初步怀疑该VO对象存在重复循环对象的问题。该对象主要用于门户中一个业务场景数据查询。

### 改进
结合线上线下分析定位到关于VO处理代码存在问题。安排开发检查相关模块代码，优化并改进，问题修复。

