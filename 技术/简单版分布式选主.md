
# 简单版分布式选主

## 背景

多服务集群模式下，定时调度、补丁升级等存在重复执行问题。

## 需求
- 定时调度器可在线配置。
- 集群模式下只有主节点执行任务调度，其他节点可执行查询和配置管理。
- 不希望增加额外服务节点（减少实施复杂度）。

## 实现方式
调研Quartz支持分布式，但运行期修改调度配置不够方便。为了满足业务需求和减少部署复杂度，最后借鉴Quartz利用库表的思想自实现简单版分布式调度器。

### 依托数据库实现选主

**选主表**

字段 | 描述
---|---
leader | 存放leader的ip/port
checkInterval | 各节点和数据库的检测间隔时间
lastTime | 最后一次执行时间
expireIn | 过期时间
存放主节点

**选主流程图**

![image](/resources/images/20200211211200.jpg)

- 

### 主节点调度执行任务
各个节点会与DB保持心跳，从主节点表中判断自己是否是主节点，如果是主节点则执行任务调度的功能。  
如何当选主节点:  
1. 主节点记录为空；  
2. 主节点记录不为空，但超时(>间隔时间+过期时间)；  

主节点超时需要自动卸载执行任务，防止出现其他节点竞选为主节点后出现任务重复执行。然后进入下一次轮训。

![image](/resources/images/20200211212500.jpg)

网络波动的情况下有可能出现主节点延迟或无法收到数据库的相应，在这个时间段里会产生新的主节点，两个主节点执行任务会出现重复冲突，这时需要保证被执行的任务是幂等或者事务一致。

## 总结
- 优点：运行期可自定义扩展业务配置，没有产生额外服务。
- 不足：调度器的可靠性依赖数据库，出现多“主节点”的情况下，需要被调度的任务具备幂等或事务一致能力。





