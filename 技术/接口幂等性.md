# 接口幂等性

* [1. 什么是幂等性](#1-什么是幂等性)
* [2. 应用场景](#2-应用场景)
  * [2.1 表单重复提交](#21-表单重复提交)
  * [2.2后台接口重复调用](#22后台接口重复调用)
* [2. 解决方案](#2-解决方案)
  * [前端JS控制](#前端js控制)
  * [token机制](#token机制)
  * [数据库字段约束](#数据库字段约束)
  * [全局唯一ID](#全局唯一id)
    * [UUID方式](#uuid方式)
    * [基于数据库自增方式](#基于数据库自增方式)
    * [数据库集群如何考虑数据库自增唯一性](#数据库集群如何考虑数据库自增唯一性)
    * [基于Redis生成全局id策略](#基于redis生成全局id策略)
    * [Twitter的snowflake(雪花)算法](#twitter的snowflake雪花算法)
    * [基于Zookeeper实现全局ID](#基于zookeeper实现全局id)
* [参考](#参考)


# 1. 什么是幂等性
一个操作，不论执行多少次，产生的效果和返回的结果都是一样。 
# 2. 应用场景
## 2.1 表单重复提交
- 场景一：在网络延迟的情况下让用户有时间点击多次submit按钮导致表单重复提交
- 场景二：表单提交后用户点击【刷新】按钮导致表单重复提交
- 场景三：用户提交表单后，点击浏览器的【后退】按钮回退到表单页面后进行再次提交


## 2.2后台接口重复调用
- 一个订单创建接口，第一次调用超时了，然后又调用了一次
- 订单创建后需要去执行扣减库存等等的后续操作，第一次调用超时后又调用一次
- 支付订单，已经发送过支付请求，第一次超时后又调用一次
- 订单完成支付后，发送消息处理一系列后续请求，中间件消息被多个机器（分布式）或者进程执行
- 对外提供接口的api如何保证幂等

# 2. 解决方案
## 前端JS控制
针对[2.1]应用场景，使用JavaScript是可以解决这个问题的，常见解决做法  
- "用JavaScript控制Form表单只能提交一次"。
- 表单提交之后，将提交按钮设置为不可用。

使用JavaScript防止表单重复提交的做法只对上述提交到导致表单重复提交的三种场景中的【场景一】有效，而对于【场景二】和【场景三】是没有用，依然无法解决表单重复提交问题。利用token机制可解。

## token机制
在服务器端生成一个唯一的随机标识号，专业术语称为Token(令牌)，同时在当前用户的Session域中保存这个Token。然后将Token发送到客户端的Form表单中，在Form表单中使用隐藏域来存储这个Token，表单提交的时候连同这个Token一起提交到服务器端，然后在服务器端判断客户端提交上来的Token与服务器端生成的Token是否一致，如果不一致，那就是重复提交了，此时服务器端就可以不处理重复提交的表单。如果相同则处理表单提交，处理完后清除当前用户的Session域中存储的标识号。

##  数据库字段约束

**插入:**

字段约束主要是通过一些主键或者唯一索引去判断执行，无法插入相同数据。  

**更新:**  
1. 悲观锁：select * from table_xxx where id=’xxx’ for update;  
2. 乐观锁：版本号控制 update goods set name=#{newName},version=#{version+1} where id=#{id} and version=${version}  
3. 状态机：设置固定的状态类型，只有满足状态要求才能执行。  

## 全局唯一ID
上游根据每一次的操作和内容从ID生成服务中心过去一个全局ID(guid等)，下游在执行操作之前判断这个唯一ID是否存在，决定是否继续执行。

### UUID方式

### 基于数据库自增方式

### 数据库集群如何考虑数据库自增唯一性

### 基于Redis生成全局id策略

### Twitter的snowflake(雪花)算法

### 基于Zookeeper实现全局ID

# 参考
[1] https://www.cnblogs.com/xdp-gacl/p/3859416.html  
[2] http://pwwtest.com/2018/07/20/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E5%90%8E%E7%AB%AF%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%B9%82%E7%AD%89%E6%80%A7%EF%BC%9F/  
[3] https://www.cnblogs.com/zhaopanpan/  
[4] https://www.cnblogs.com/itsoku123/p/10868076.html  
[5] https://blog.csdn.net/weixin_38652136/article/details/85209662
